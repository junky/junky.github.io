<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="description" content="">
    <meta name="author" content="junky">

    <title>junky.github.io</title>

    <!-- Bootstrap core CSS -->
    <link rel="stylesheet" href="http://netdna.bootstrapcdn.com/bootstrap/3.1.1/css/bootstrap.min.css">

    <!-- Custom styles for this template -->
    <style>    
      body {
        padding-top: 50px;
      }
      .starter-template {
        padding: 40px 15px;
        text-align: center;
      }
      .odometer {
         font-size: 100px;
         padding-bottom: 50px;
      }
    </style>
    <link rel="stylesheet" href="http://netdna.bootstrapcdn.com/bootstrap/3.1.1/css/bootstrap-theme.min.css">

    <!-- Odometr includes -->
    <link rel="stylesheet" href="http://github.hubspot.com/odometer/themes/odometer-theme-car.css" />
    <script src="http://github.hubspot.com/odometer/odometer.js"></script>
    
    <!-- HTML5 shim and Respond.js IE8 support of HTML5 elements and media queries -->
    <!--[if lt IE 9]>
      <script src="https://oss.maxcdn.com/libs/html5shiv/3.7.0/html5shiv.js"></script>
      <script src="https://oss.maxcdn.com/libs/respond.js/1.4.2/respond.min.js"></script>
    <![endif]-->
  </head>

  <body>

    <div class="navbar navbar-inverse navbar-fixed-top" role="navigation">
      <div class="container">
        <div class="navbar-header">
          <button type="button" class="navbar-toggle" data-toggle="collapse" data-target=".navbar-collapse">
            <span class="sr-only">Toggle navigation</span>
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
          </button>
          <a class="navbar-brand" href="#">junky.github.io</a>
        </div>
        <div class="collapse navbar-collapse">
          <ul class="nav navbar-nav">
            <li><a href="/">Home</a></li>
            <li class="active"><a href="/websockets.html">Websockets</a></li>
          </ul>
        </div><!--/.nav-collapse -->
      </div>
    </div>

    <div class="container">

      <div class="starter-template">
        <div style="padding: 20px 30px;">
          <b>Server URL:</b>
          <input type="text" name="server" id="server" style="width: 250px;" value="ws://localhost:10080/websocket/" />
          <input type="button" value="Open" id="conn_button" onclick="onConnButtonClick();" />
        </div>
        
        <div id="odometer" class="odometer">123</div>
        <div style="padding-top:50px;">
          <textarea id="log" style="width: 600px; height: 250px;"></textarea>
        </div>
        
      </div>

    </div><!-- /.container -->


    <!-- Bootstrap core JavaScript
    ================================================== -->
    <!-- Placed at the end of the document so the pages load faster -->
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.11.0/jquery.min.js"></script>
    <script src="https://netdna.bootstrapcdn.com/bootstrap/3.1.1/js/bootstrap.min.js"></script>

    <script type='text/javascript'>
    timer = 0;
    websocket = null;
    isConnected = false;
    
    function dateToString(date) {
        var dateOfString = date.getHours() + ":" + date.getMinutes() + ":" + date.getSeconds();
        return dateOfString;
    }
    
	function log(msg) {
	    $('#log').text(dateToString(new Date()) + " " + msg + "\n" + $('#log').text());
    }

    function openWebSocket(wsUri) { 
    	log('Connecting to ' + wsUri + ' ... ');
        websocket = new WebSocket(wsUri); 
        websocket.onopen = function(evt) { onOpen(evt) }; 
        websocket.onclose = function(evt) { onClose(evt) }; 
        websocket.onmessage = function(evt) { onMessage(evt) }; 
        websocket.onerror = function(evt) { onError(evt) }; 
    }  
    
    function onOpen(evt) { 
    	log("CONNECTED"); 
    	doSend('Websocket works.');
        timer = setTimeout(sendNumberedMessage, 5000);
        isConnected = true;
        $('#conn_button').val('Close');
    }  
    
    function onClose(evt) { 
    	log("DISCONNECTED");
    	clearTimeout(timer);
    	timer = 0;
    	isConnected = false;
        $('#conn_button').val('Open');
    }  
    
    function onMessage(evt) { 
    	log('RESPONSE: ' + evt.data);
    	s = evt.data;
    	if(s.indexOf("nm:")==0) {
    		odometer.innerHTML = s.substring(3);
    	}
    }  
    
    function onError(evt) { 
    	log('ERROR: ' + evt.data); 
        clearTimeout(timer);
        timer = 0;
    }  
    
    function doSend(message) { 
    	log("SENT: " + message);  
    	websocket.send(message); 
    }

    function getRandomInt (min, max) {
        return Math.floor(Math.random() * (max - min + 1)) + min;
    }
    
    function sendNumberedMessage() {
    	var r = getRandomInt(0, 999);
    	doSend('nm:' + r);
    	timer = setTimeout(sendNumberedMessage, 5000);
    }
    
    function onConnButtonClick(){
    	if(!isConnected) {
    	    openWebSocket($('#server').val());
    	} else {
            clearTimeout(timer);
            timer = 0;
    		websocket.close();
    	}
    }
    
    </script>

  </body>
</html>
